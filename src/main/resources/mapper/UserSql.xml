<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.mapper.UserMapper">
    <select id="getSelectUser" resultType="UserDto" useCache="false">
        SELECT u.id, u.email, u.nickname, u.profile_image as profileImage, 
        u.gender, u.height, u.current_weight as currentWeight, 
        u.age, u.activity_level as activityLevel,
        u.goal_weight as goalWeight, u.type,
        u.my_intro as myIntro,
        (SELECT COUNT(*) FROM friendship WHERE user1_id = u.id OR user2_id = u.id) as friendCount,
        (SELECT COUNT(*) FROM user_badge WHERE user_id = u.id AND is_achieved = 1) as badgeCount,
        (SELECT COUNT(*) FROM exercise_record WHERE user_id = u.id) as achievementCount,
        (SELECT COUNT(*) FROM board WHERE user_id = u.id) as postCount,
        (SELECT COUNT(*) FROM comment WHERE user_id = u.id) as commentCount
        FROM user u
        WHERE u.id = #{id}
    </select>
    
    <select id="getSelectNickname" parameterType="String" resultType="UserDto">
        SELECT u.id, u.email, u.nickname, u.profile_image as profileImage, 
        u.gender, u.height, u.current_weight as currentWeight, 
        u.age, u.activity_level as activityLevel,
        u.goal_weight as goalWeight, u.type,
        u.carbohydrate, u.protein, u.fat,
        (SELECT COUNT(*) FROM friendship WHERE user1_id = u.id OR user2_id = u.id) as friendCount,
        (SELECT COUNT(*) FROM user_badge WHERE user_id = u.id AND is_achieved = 1) as badgeCount,
        (SELECT COUNT(*) FROM exercise_record WHERE user_id = u.id) as achievementCount,
        (SELECT COUNT(*) FROM board WHERE user_id = u.id) as postCount,
        (SELECT COUNT(*) FROM comment WHERE user_id = u.id) as commentCount
        FROM user u
        WHERE u.nickname = #{nickname}
    </select>
    
    <update id="mypageUpdateUser" parameterType="UserDto">
        UPDATE user 
        SET nickname = #{nickname},
            profile_image = #{profileImage},
            gender = #{gender},
            age = #{age},
            height = #{height},
            current_weight = #{currentWeight},
            goal_weight = #{goalWeight},
            activity_level = #{activityLevel},
            type = #{type}
        WHERE id = #{id}
    </update>
    
    <select id="getLikeList" resultType="UserDto" useCache="false">
        SELECT b.id, b.content as title, 'board' as type
        FROM board b
        INNER JOIN board_like bl ON b.id = bl.board_id
        WHERE bl.user_id = #{userId}
        ORDER BY b.created_at DESC
        LIMIT 10
    </select>

    <select id="getUserById" parameterType="string" resultType="UserDto">
        SELECT id, email, password, nickname as userId, profile_image as profileImage, gender
        FROM user
        WHERE email = #{id}
    </select>
</mapper>