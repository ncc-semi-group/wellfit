<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.board.mapper.BoardMapper">
	<select id="getSelectUserId" parameterType="int" resultMap="BoardResultMap">
		SELECT b.id, b.user_id, b.created_at, b.content,
			   h.id as tag_id, h.tag
		FROM board b
		LEFT JOIN board_hashtag bh ON b.id = bh.board_id
		LEFT JOIN hashtag h ON bh.tag_id = h.id
		WHERE b.user_id = #{userId}
		ORDER BY b.created_at DESC
	</select>
	
	<!-- 게시물 목록 조회 (해시태그 포함) -->
	<select id="getBoardList" resultMap="BoardResultMap">
		SELECT b.id, b.user_id, b.created_at, b.content,
			   h.id as tag_id, h.tag
		FROM board b
		LEFT JOIN board_hashtag bh ON b.id = bh.board_id
		LEFT JOIN hashtag h ON bh.tag_id = h.id
		ORDER BY b.created_at DESC
	</select>
	
	<!-- 특정 게시물 조회 (해시태그 포함) -->
	<select id="getBoard" parameterType="int" resultMap="BoardResultMap">
		SELECT b.id, b.user_id, b.created_at, b.content,
			   h.id as tag_id, h.tag
		FROM board b
		LEFT JOIN board_hashtag bh ON b.id = bh.board_id
		LEFT JOIN hashtag h ON bh.tag_id = h.id
		WHERE b.id = #{boardId}
	</select>
	
	<!-- ResultMap 정의 -->
	<resultMap id="BoardResultMap" type="BoardDto">
		<id property="id" column="id"/>
		<result property="userId" column="user_id"/>
		<result property="createdAt" column="created_at"/>
		<result property="content" column="content"/>
		<!-- 해시태그 목록을 담을 컬렉션 매핑 -->
		<collection property="hashtags" ofType="HashtagDto">
			<id property="id" column="tag_id"/>
			<result property="tag" column="tag"/>
		</collection>
	</resultMap>
	
	<!-- 게시물 등록 -->
	<insert id="insertBoard" parameterType="BoardDto" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO board (user_id, content, created_at)
		VALUES (#{userId}, #{content}, NOW())
	</insert>
	
	<!-- 해시태그 등록 -->
	<insert id="insertBoardHashtag">
		INSERT INTO board_hashtag (board_id, tag_id)
		VALUES (#{boardId}, #{tagId})
	</insert>
	
	<!-- 해시태그로 게시물 검색 -->
	<select id="searchBoardsByHashtag" parameterType="string" resultMap="BoardResultMap">
		SELECT b.id, b.user_id, b.created_at, b.content,
			   h.id as tag_id, h.tag
		FROM board b
		INNER JOIN board_hashtag bh ON b.id = bh.board_id
		INNER JOIN hashtag h ON bh.tag_id = h.id
		WHERE h.tag LIKE CONCAT('%', #{keyword}, '%')
		ORDER BY b.created_at DESC
	</select>
	
	<!-- 사용자의 게시물 목록 조회 -->
	<select id="getBoardsByUserId" parameterType="int" resultMap="BoardResultMap">
		SELECT b.id, b.user_id, b.created_at, b.content,
			   h.id as tag_id, h.tag
		FROM board b
		LEFT JOIN board_hashtag bh ON b.id = bh.board_id
		LEFT JOIN hashtag h ON bh.tag_id = h.id
		WHERE b.user_id = #{userId}
		ORDER BY b.created_at DESC
	</select>
</mapper>